@{
    ViewData["Title"] = "Setup Two-Factor Authentication - Medixus Healthcare";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="~/css/auth.css">
    <style>
        .setup-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .setup-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
        }

        .auth-content-wide {
            max-width: 650px;
            margin: 0 auto;
        }

        .setup-steps {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .setup-step {
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

            .setup-step:hover {
                border-color: var(--primary);
                transform: translateX(5px);
            }

        .step-number {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .step-content {
            flex: 1;
        }

            .step-content h3 {
                margin: 0 0 0.75rem 0;
                font-size: 1.25rem;
                color: var(--text-primary);
            }

            .step-content p {
                margin: 0 0 1rem 0;
                color: var(--text-secondary);
                line-height: 1.6;
            }

        .app-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .qr-code-container {
            text-align: center;
            padding: 1.5rem;
            background: white;
            border-radius: var(--radius-lg);
            border: 2px solid var(--border);
            margin: 1rem 0;
        }

            .qr-code-container img {
                max-width: 220px;
                border-radius: var(--radius);
            }

        .manual-code {
            display: block;
            padding: 1rem;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-family: monospace;
            font-size: 1rem;
            letter-spacing: 0.15em;
            margin-top: 0.75rem;
            text-align: center;
            font-weight: 600;
            color: var(--primary);
        }

        .recovery-codes {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 2px solid var(--warning);
            margin-top: 2rem;
        }

            .recovery-codes h4 {
                margin: 0 0 1rem 0;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                color: var(--text-primary);
            }

                .recovery-codes h4 i {
                    color: var(--warning);
                }

            .recovery-codes p {
                margin: 0 0 1rem 0;
                color: var(--text-secondary);
                font-size: 0.95rem;
            }

        .codes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .recovery-code-item {
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: monospace;
            font-size: 0.95rem;
            text-align: center;
            font-weight: 600;
            color: var(--text-primary);
        }

        .help-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="auth-wrapper">
        <div class="auth-container" style="max-width: 700px;">
            <div class="auth-content auth-content-wide">
                <div class="setup-header">
                    <div class="setup-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h1>Two-Factor Authentication</h1>
                    <p class="auth-subtitle">Add an extra layer of security to your account</p>
                </div>

                <div class="setup-steps">
                    <!-- Step 1: Download App -->
                    <div class="setup-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3>Download Authenticator App</h3>
                            <p>Install an authenticator app on your smartphone to generate verification codes.</p>
                            <div class="app-buttons">
                                <a href="https://apps.apple.com/app/google-authenticator/id388497605" target="_blank" class="btn btn-secondary">
                                    <i class="fab fa-apple"></i>
                                    <span>App Store</span>
                                </a>
                                <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2" target="_blank" class="btn btn-secondary">
                                    <i class="fab fa-google-play"></i>
                                    <span>Google Play</span>
                                </a>
                            </div>
                            <p class="help-text">
                                <i class="fas fa-info-circle"></i>
                                Recommended apps: Google Authenticator, Microsoft Authenticator, Authy
                            </p>
                        </div>
                    </div>

                    <!-- Step 2: Scan QR Code -->
                    <div class="setup-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3>Scan QR Code</h3>
                            <p>Open your authenticator app and scan this QR code:</p>
                            <div class="qr-code-container">
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=otpauth://totp/Medixus:user@example.com?secret=JBSWY3DPEHPK3PXP&issuer=Medixus" alt="QR Code" />
                            </div>
                            <p class="help-text">Or enter this code manually in your app:</p>
                            <code class="manual-code">JBSW Y3DP EHPK 3PXP</code>
                        </div>
                    </div>

                    <!-- Step 3: Verify Setup -->
                    <div class="setup-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3>Verify Setup</h3>
                            <p>Enter the 6-digit code from your authenticator app to complete setup:</p>
                            <form method="post" asp-action="Verify2FA">
                                @Html.AntiForgeryToken()

                                <div class="form-group">
                                    <div class="otp-inputs" id="otpInputs">
                                        <input type="text" class="otp-input" maxlength="1" inputmode="numeric" autocomplete="off" />
                                        <input type="text" class="otp-input" maxlength="1" inputmode="numeric" autocomplete="off" />
                                        <input type="text" class="otp-input" maxlength="1" inputmode="numeric" autocomplete="off" />
                                        <input type="text" class="otp-input" maxlength="1" inputmode="numeric" autocomplete="off" />
                                        <input type="text" class="otp-input" maxlength="1" inputmode="numeric" autocomplete="off" />
                                        <input type="text" class="otp-input" maxlength="1" inputmode="numeric" autocomplete="off" />
                                    </div>
                                    <input type="hidden" id="codeInput" name="Code" />
                                </div>

                                <button type="submit" class="btn btn-primary btn-block" id="verifyBtn" disabled>
                                    <i class="fas fa-check-circle"></i>
                                    <span>Verify & Enable 2FA</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Recovery Codes -->
                <div class="recovery-codes">
                    <h4>
                        <i class="fas fa-key"></i>
                        <span>Recovery Codes</span>
                    </h4>
                    <p>Save these recovery codes in a safe place. You can use them to access your account if you lose access to your authenticator app.</p>
                    <div class="codes-grid">
                        <code class="recovery-code-item">A3F2-8D4E-9B1C</code>
                        <code class="recovery-code-item">7C9A-2E5F-6D8B</code>
                        <code class="recovery-code-item">4B8F-1A3E-7C2D</code>
                        <code class="recovery-code-item">9E2C-5F7A-3D1B</code>
                        <code class="recovery-code-item">6D1B-8E4F-2A9C</code>
                        <code class="recovery-code-item">2F5A-9C3E-7B1D</code>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.75rem;">
                        <button type="button" class="btn btn-secondary" onclick="downloadRecoveryCodes()">
                            <i class="fas fa-download"></i>
                            <span>Download Codes</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="printRecoveryCodes()">
                            <i class="fas fa-print"></i>
                            <span>Print Codes</span>
                        </button>
                    </div>
                </div>

                <div class="auth-divider">
                    <span>Or go back</span>
                </div>

                <a href="/dashboard" class="btn btn-secondary btn-block">
                    <i class="fas fa-times"></i>
                    <span>Skip for Now</span>
                </a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const otpInputs = document.querySelectorAll('.otp-input');
            const codeInput = document.getElementById('codeInput');
            const verifyBtn = document.getElementById('verifyBtn');

            // OTP Input Handler
            otpInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');

                    if (e.target.value && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }

                    updateCode();
                    e.target.classList.toggle('filled', !!e.target.value);
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });

                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '');
                    pastedData.split('').forEach((char, i) => {
                        if (index + i < otpInputs.length) {
                            otpInputs[index + i].value = char;
                            otpInputs[index + i].classList.add('filled');
                        }
                    });
                    updateCode();
                });
            });

            function updateCode() {
                const code = Array.from(otpInputs).map(input => input.value).join('');
                codeInput.value = code;
                verifyBtn.disabled = code.length !== 6;
            }
        });

        function downloadRecoveryCodes() {
            const codes = Array.from(document.querySelectorAll('.recovery-code-item'))
                .map(el => el.textContent)
                .join('\n');

            const blob = new Blob([
                'Medixus Healthcare - Recovery Codes\n',
                'Generated: ' + new Date().toLocaleString() + '\n\n',
                'Keep these codes in a safe place!\n\n',
                codes
            ], { type: 'text/plain' });

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'medixus-recovery-codes.txt';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function printRecoveryCodes() {
            window.print();
        }
    </script>
</body>
</html>